var $Utils=Utils.prototype,Game=function(e){this.init(e)};Game.prototype.init=function(e){var t=this;e=e||{},this.availableLeaders=[{id:"sterling",name:"Sterling",bio:""},{id:"gunter",name:"GÃ¼nter",bio:""},{id:"les",name:"Lesli",bio:""}],this.seasons=["Spring","Summer","Fall","Winter"],this.timer,this.hourCounter=1,this.dayCounter=1,this.seasonCounter=0,this.yearCounter=1,this.currentHour=1,this.currentDay=1,this.currentSeason=this.seasons[this.seasonCounter%4],this.isPlaying=0,this.timerInterval=1e3,this.isPopupVisible=0,this.hourlyEvents={},this.dailyEvents={},this.seasonalEvents={},this.yearlyEvents={},this.dailyMealsDesired=e.dailyMealsDesired||0,this.dailyMealsServed=e.dailyMealsServed||0,this.lowFoodDaysCount=e.lowFoodDaysCount||0,this.starvationMarkers=e.starvationMarkers||0,this.isGameOver=e.isGameOver||0,this.scheduledChildAgingEvents=e.scheduledChildAgingEvents||{7:1},this.scheduledAdultAgingEvents=e.scheduledAdultAgingEvents||{9:1,12:1,16:1},this.scheduledDeathEvents=e.scheduledAgingEvents||{22:1},this.availableSettlers=ko.observable($Utils.setDefaultValue(e.availableSettlers,5)),this.workingSettlers=ko.observable(e.workingSettlers||0),this.busySettlers=ko.observable(e.busySettlers||0),this.childSettlers=ko.observable($Utils.setDefaultValue(e.childSettlers,1)),this.adultSettlers=ko.observable($Utils.setDefaultValue(e.adultSettlers,1)),this.oldSettlers=ko.observable($Utils.setDefaultValue(e.oldSettlers,1)),this.resources=ko.observable(e.resources||this._getDefaultResources()),this.playSpeed=ko.observable(1),this.mapArray=ko.observable([]),this.newGameGeneratedMaps=ko.observableArray([]),this.totalSettlers=ko.computed(function(){return(t.availableSettlers()||0)+(t.workingSettlers()||0)+(t.busySettlers()||0)}),document.getElementById("current-hour").innerHTML=this.currentHour,document.getElementById("current-day").innerHTML=this.currentDay,document.getElementById("current-season").innerHTML=this.currentSeason,document.getElementById("current-year").innerHTML=this.yearCounter,this._setupDefaultTimeEvents(),this.somePerson=new Person({name:"Bob"}),this.someSettler=new Settler({name:"Jeff",tribe:"Umpqua"})},Game.prototype.mainLoop=function(){this.currentHour,this.currentDay,this.currentSeasonIdx;this.hourCounter++,this.currentHour=this.hourCounter%24,document.getElementById("current-hour").innerHTML=this.currentHour,this.processHourlyEvents(),0==this.currentHour&&(this.dayCounter++,this.currentDay=this.dayCounter%30,document.getElementById("current-day").innerHTML=this.currentDay,this.processDailyEvents(),0==this.currentDay&&(this.seasonCounter++,this.currentSeasonIdx=this.seasonCounter%4,this.currentSeason=this.seasons[this.currentSeasonIdx],document.getElementById("current-season").innerHTML=this.currentSeason,this.processSeasonalEvents(),0==this.currentSeasonIdx&&(this.yearCounter++,document.getElementById("current-year").innerHTML=this.yearCounter,this.processYearlyEvents())))},Game.prototype.processHourlyEvents=function(){var e=this.hourlyEvents[this.currentHour];void 0!=e&&$.each(e,function(e,t){game[t]()})},Game.prototype.processDailyEvents=function(){var e=this.dailyEvents[this.currentDay];void 0!=e&&$.each(e,function(e,t){game[t]()}),this._doDailyStarvationCalculation(),this.dailyMealsDesired=0,this.dailyMealsServed=0},Game.prototype.processSeasonalEvents=function(){var e=this.seasonalEvents[this.seasonCounter];void 0!=e&&$.each(e,function(e,t){game[t]()}),this.doChildAgingEventCheck(),this.doAdultAgingEventCheck(),this.doDeathEventCheck()},Game.prototype.processYearlyEvents=function(){},Game.prototype._doDailyStarvationCalculation=function(){this.dailyMealsServed/this.dailyMealsDesired<.6?(this.starvationMarkers++,this.starvationMarkers>10&&(this.starvationMarkers=10),console.log("Starvation markers: "+this.starvationMarkers)):(this.starvationMarkers-=2,this.starvationMarkers<0&&(this.starvationMarkers=0),console.log("Starvation markers: "+this.starvationMarkers)),this.starvationMarkers>3&&this.processStarvationEvent()},Game.prototype.consumeFoodEvent=function(){var e=this.resources().food,t=this.totalSettlers();this.dailyMealsDesired+=t;var s=e-t,o=0>s?t+s:t;this.dailyMealsServed+=o,this._updateObservableProp(this.resources,{food:e-o}),console.log("Food leftover after serving: "+this.resources().food)},Game.prototype.doChildAgingEventCheck=function(){void 0!=this.scheduledChildAgingEvents[this.seasonCounter]&&this.ageChildren(this.scheduledChildAgingEvents[this.seasonCounter])},Game.prototype.doAdultAgingEventCheck=function(){void 0!=this.scheduledAdultAgingEvents[this.seasonCounter]&&this.ageAdults(this.scheduledAdultAgingEvents[this.seasonCounter])},Game.prototype.doDeathEventCheck=function(){void 0!=this.scheduledDeathEvents[this.seasonCounter]&&this.killOldAdults(this.scheduledDeathEvents[this.seasonCounter])},Game.prototype.ageChildren=function(e){for(var t=0;e>t;t++){var s=4*$Utils.doRand(40,51),o=this.seasonCounter+s;this.scheduledAdultAgingEvents[o]=(this.scheduledAdultAgingEvents[o]||0)+1}},Game.prototype.ageAdults=function(e){for(var t=0;e>t;t++){var s=4*$Utils.doRand(10,21),o=this.seasonCounter+s;this.scheduledDeathEvents[o]=(this.scheduledDeathEvents[o]||0)+1}},Game.prototype.killOldAdults=function(e){for(var t=0;e>t;t++)this.availableSettlers()>0?(this.availableSettlers(this.availableSettlers()-1),console.log("A settler has died of old age. Num left: "+this.totalSettlers())):this.workingSettlers()>0?(this.workingSettlers(this.workingSettlers()-1),console.log("A settler has died of old age. Num left: "+this.totalSettlers())):this.busySettlers()>0&&(this.busySettlers(this.busySettlers()-1),console.log("A settler has died of old age. Num left: "+this.totalSettlers())),0==this.availableSettlers()&&0==this.workingSettlers()&&0==this.busySettlers()&&this.gameOver()},Game.prototype.processStarvationEvent=function(){var e=$Utils.doRand(1,11);e<=this.starvationMarkers&&(this.availableSettlers()>0?(this.availableSettlers(this.availableSettlers()-1),console.log("A settler has died. Num left: "+this.totalSettlers())):this.workingSettlers()>0?(this.workingSettlers(this.workingSettlers()-1),console.log("A settler has died. Num left: "+this.totalSettlers())):this.busySettlers()>0&&(this.busySettlers(this.busySettlers()-1),console.log("A settler has died. Num left: "+this.totalSettlers())),0==this.totalSettlers()&&this.gameOver())},Game.prototype.startMainTimer=function(){var e=this;this.timer=setInterval(function(){e.mainLoop()},this.timerInterval)},Game.prototype.pauseMainTimer=function(){clearInterval(this.timer)},Game.prototype.restartMainTimer=function(){this.pauseMainTimer(),this.startMainTimer()},Game.prototype.spcAction=function(){this.isPopupVisible||(this.isPlaying?this.pauseMainTimer():this.isGameOver||this.startMainTimer(),this.isPlaying=!this.isPlaying)},Game.prototype.plusAction=function(){4!=this.playSpeed()&&(this.playSpeed(this.playSpeed()+1),this._setIntervalBasedOnPlaySpeedInteger(),this.isPlaying&&this.restartMainTimer())},Game.prototype.minusAction=function(){1!=this.playSpeed()&&(this.playSpeed(this.playSpeed()-1),this._setIntervalBasedOnPlaySpeedInteger(),this.isPlaying&&this.restartMainTimer())},Game.prototype._setIntervalBasedOnPlaySpeedInteger=function(){1==this.playSpeed()?this.timerInterval=1e3:2==this.playSpeed()?this.timerInterval=500:3==this.playSpeed()?this.timerInterval=250:4==this.playSpeed()&&(this.timerInterval=100)},Game.prototype._updateObservableProp=function(e,t,s,o){if(!ko.isObservable(e))return console.log("_updateObservableProp requires an observable as its first argument"),!1;s=$Utils.setDefaultValue(s,0),o=$Utils.setDefaultValue(o,1);var n=e(),i=[];for(existingProp in n)void 0!=t[existingProp]?(n[existingProp]=t[existingProp],delete t[existingProp]):i.push(existingProp);if(s&&$.each(i,function(e,t){delete n[t]}),o)for(newProp in t)n[newProp]=t[newProp];e(n)},Game.prototype._hideOneElemAndShowAnother=function(e,t,s,o,n){var i=new Promise(function(i){e=e instanceof jQuery?e:$(e),t=t instanceof jQuery?t:$(t),s=void 0!=s?s:300,o=void 0!=o?o:300,e.fadeOut(s,function(){n&&"function"==typeof n&&n(),t.fadeIn(o,function(){setTimeout(function(){i()},0)})})});return i},Game.prototype.revealText=function(e,t,s){var o=new Promise(function(o){e=e instanceof jQuery?e:$(e),t=void 0!=t?t:2e3,s=s||0;var n=e.css("position"),i=e.css("overflow");e.css("position","relative"),e.css("overflow","hidden");var r=$("<div></div>").css({position:"absolute",top:"0px",left:"-10%",width:"110%",height:"100%"}).addClass("white-gradient-with-left-transparency").appendTo(e);e.show(),r.animate({left:"100%"},t,"linear",function(){r.remove(),e.css("position",n),e.css("overflow",i),setTimeout(function(){o()},s)})});return o},Game.prototype.fadeOutDiv=function(e,t,s){var o=new Promise(function(o){e=e instanceof jQuery?e:$(e),t=void 0!=t?t:2e3,s=s||0;var n=e.css("position"),i=e.css("overflow");e.css("position","relative"),e.css("overflow","hidden");var r=$("<div></div>").css({position:"absolute",top:"-125%",left:"0px",width:"100%",height:"125%"}).addClass("white-gradient-with-bottom-transparency").appendTo(e);r.animate({top:"0%"},t,"linear",function(){e.hide(0,function(){r.remove(),e.css("position",n),e.css("overflow",i),setTimeout(function(){o()},s)})})});return o},Game.prototype.generateHeightMapUsingParticleDepositionAlgorithm=function(e){e=e||{};for(var t,s,o=e.width||100,n=e.height||100,i=e.numberOfDropPoints||10,r=e.minParticlesPerPoint||1,a=e.maxParticlesPerPoint||5,l=e.numPasses||1,h=e.minRadiusToLookForLowerNeighbors||1,u=e.maxRadiusToLookForLowerNeighbors||1,d=e.dontRepeatPoints||0,c=$Utils.setDefaultValue(e.numBlurPasses,1),v=$Utils.setDefaultValue(e.moveTowardsCenterOnSuccessivePasses,1),p=$Utils.setDefaultValue(e.edgePadding,1),f=f||"terrain",m=[],g={},y=0;n>y;y++){void 0==m[y]&&(m[y]=[]);for(var E=0;o>E;E++)m[y][E]=0}for(var S=0;l>S;S++){var M=1+p,b=n-p,T=1+p,P=o-p;if(v){var G=Math.round(o/2),C=Math.round(n/2),w=Math.round(.25*o),D=C-w,A=C+w,k=G-w,I=G+w;M+=S,b-=S,T+=S,P-=S,M=M>D?D:M,b=A>b?A:b,T=T>k?k:T,P=I>P?I:P}for(var O=0;i>O;O++){for(s=$Utils.doRand(M,b),t=$Utils.doRand(T,P),void 0==g[s]&&(g[s]={});d&&1==g[s][t];)s=$Utils.doRand(M,b),t=$Utils.doRand(T,P),void 0==g[s]&&(g[s]={});d&&(g[s][t]=1);for(var $=($Utils.doRand(r,a+1),0);i>$;$++){m[s][t]+=1;var L=$Utils.doRand(h,u+1),N=this._getLowestPointNeighbor(s,t,L,n,o,m);m[s][t]-N.z>1&&(m[s][t]-=1,m[N.y][N.x]+=1)}}}c>0&&(m=this._applyBlurToMap(c,m));var _=["#0004E3","#D0E300","#56C656","#0a9000","#8C8C8C","#8C8C8C"],x=["water","sand","grassland","woods","mountain","mountain"];return m=this._getMapArrayCoalescedAndTransformedIntoGivenParameters(m,"terrain"==f?x:_,"terrain"==f?"mountain":"#8C8C8C")},Game.prototype._getLowestPointNeighbor=function(e,t,s,o,n,i){for(var r=0>e-s?0:e-s,a=e+s>o?o-1:e+s,l=0>t-s?0:t-s,h=t+s>n?n-1:t+s,u={},d=r;a>d;d++)for(var c=l;h>c;c++){var v=i[d][c];void 0==u[v]&&(u[v]=[]),u[v].push({x:c,y:d,z:v})}var p=Object.keys(u).sort(),f=p[0];return $Utils.chooseRandomly(u[f])},Game.prototype._applyBlurToMap=function(e,t){for(var s,o,n,i,r=[],a=[],l=[.06136,.24477,.38774,.24477,.06136],h=l,u=Math.round(h.length/2)-1,d=0,c=0;e>c;c++){i=0==r.length?t:r;for(var v=0;v<i.length;v++)for(var p=0;p<i[v].length;p++){d=0;for(var f=0;f<h.length;f++)s=f-u,o=p+s,o=0>o?0:o,o=o>i[v].length-1?i[v].length-1:o,d+=i[v][o]*h[f];void 0==a[v]&&(a[v]=[]),a[v][p]=Math.ceil(d)}for(var m=0;m<a.length;m++)for(var g=0;g<a[m].length;g++){for(d=0,f=0;f<h.length;f++)s=f-u,n=m+s,n=0>n?0:n,n=n>a.length-1?a.length-1:n,d+=a[n][g]*h[f];void 0==r[m]&&(r[m]=[]),r[m][g]=Math.ceil(d)}}return r},Game.prototype._coalesceMapHeightsIntoSequentialValues=function(e,t,s){s=s||0;var o=this._getDistinctHeights(e),n=o[0],i=o[o.length-1],r=i-n,a=r+1;t=t>a?a:t;var l=Math.floor((r+1)/t);s&&(l=1);var h=_.map(o,function(e,t){return t%l===0?o.slice(t,t+l):null}).filter(function(e){return e});return h},Game.prototype._getDistinctHeights=function(e){for(var t={},s=0;s<e.length;s++)for(var o=0;o<e[s].length;o++)t[e[s][o]]=1;var n=Object.keys(t).sort();return n},Game.prototype._getMapArrayCoalescedAndTransformedIntoGivenParameters=function(e,t,s){var o,n=0;void 0==t?(o=1,n=1,t=[],s="#ff0000"):o=t.length;var i=this._coalesceMapHeightsIntoSequentialValues(e,o,n),r=i.length,a={};_.forEach(i,function(e,t){_.forEach(e,function(e){a[e]=t})});var l,h,u,d,c=[];if(n){var v=Math.floor(255/r);for(h=0;255>h;h+=v)l=h.toString(16),1==l.length&&(l="0"+l),t.push("#"+l+l+l)}for(var p=(Object.keys(t),0);p<e.length;p++)for(var f=0;f<e[p].length;f++)u=e[p][f],d=void 0!=t[a[u]]?t[a[u]]:s,void 0==c[p]&&(c[p]=[]),c[p][f]={mappedValue:d,height:u};return c},Game.prototype.translateHeightsIntoTerrain=function(){},Game.prototype._getMinAndMaxHeights=function(e){for(var t,s,o,n=0;n<e.length;n++)for(var i=0;i<e[n].length;i++)o=e[n][i],void 0==t&&void 0==s&&(t=o,s=o),t>o&&(t=o),o>s&&(s=o);return[t,s]},Game.prototype._TESTLOGMAP=function(e){for(var t=0;t<e.length;t++)console.log(e[t].join(" "))},Game.prototype.gameOver=function(){console.log("No settlers left."),this.pauseMainTimer(),this.isGameOver=1},Game.prototype.newGame=function(){var e=this,t=[];this._hideOneElemAndShowAnother("#newgame-content","#loading",300,300).then(function(){return new Promise(function(s){for(var o=0;6>o;o++)t.push(game.generateHeightMapUsingParticleDepositionAlgorithm({width:50,height:50,numberOfDropPoints:10,minParticlesPerPoint:1,maxParticlesPerPoint:1,numPasses:10,minRadiusToLookForLowerNeighbors:1,maxRadiusToLookForLowerNeighbors:1,numBlurPasses:2,edgePadding:5}));e.newGameGeneratedMaps(t),s()})}).then(function(){return e._hideOneElemAndShowAnother("#loading","#intro-content",0,300)}).then(function(){return e.revealText("#intro-s1-p1",0,0)}).then(function(){return e.revealText("#intro-s1-p2",0,0)}).then(function(){$("#intro-s1-buttons").fadeIn(0)})},Game.prototype._setupDefaultTimeEvents=function(){var e=this;$.each([7,12,18],function(t,s){e.hourlyEvents[s]=$Utils.pushOntoArray(e.hourlyEvents[s],"consumeFoodEvent")})},Game.prototype._getDefaultResources=function(){return{food:105}},Game.prototype._translateTerrainTypeIntoColor=function(e){var t={water:"#0004E3",sand:"#D0E300",grassland:"#56C656",woods:"#0a9000",mountain:"#8C8C8C"};return void 0!=t[e]?t[e]:"#ffffff"},Game.prototype.continueIntroFrom=function(e){var t=this;"p1"==e&&this.fadeOutDiv("#intro-s1",600).then(function(){return $("#intro-s2").show(),t.revealText("#intro-s2-p1",0,0)}).then(function(){return t.revealText("#intro-s2-p2",0,0)}).then(function(){return t.revealText("#intro-s2-p3",0,0)}).then(function(){$("#intro-s2-buttons").fadeIn(0)})},Game.prototype.hideModal=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.showModalClose=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.modalWindowTitle=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.modalWindowText=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.showModalWindowFooter=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.loadGame=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.saveGame=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.logMessages=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.showFaq=function(){console.log("NOT IMPLEMENTED YET")};