var $Utils=Utils.prototype,Game=function(e){this.init(e)};Game.prototype.init=function(e){var t=this;e=e||{},this.availableLeaders=[{id:"sterling",name:"Sterling",bio:""},{id:"gunter",name:"GÃ¼nter",bio:""},{id:"les",name:"Lesli",bio:""}],this.seasons=["Spring","Summer","Fall","Winter"],this.timer,this.hourCounter=1,this.dayCounter=1,this.seasonCounter=0,this.yearCounter=1,this.currentHour=1,this.currentDay=1,this.currentSeason=this.seasons[this.seasonCounter%4],this.isPlaying=0,this.timerInterval=1e3,this.isPopupVisible=0,this.hourlyEvents={},this.dailyEvents={},this.seasonalEvents={},this.yearlyEvents={},this.dailyMealsDesired=e.dailyMealsDesired||0,this.dailyMealsServed=e.dailyMealsServed||0,this.lowFoodDaysCount=e.lowFoodDaysCount||0,this.starvationMarkers=e.starvationMarkers||0,this.isGameOver=e.isGameOver||0,this.scheduledChildAgingEvents=e.scheduledChildAgingEvents||{7:1},this.scheduledAdultAgingEvents=e.scheduledAdultAgingEvents||{9:1,12:1,16:1},this.scheduledDeathEvents=e.scheduledAgingEvents||{22:1},this.availableSettlers=ko.observable($Utils.setDefaultValue(e.availableSettlers,5)),this.workingSettlers=ko.observable(e.workingSettlers||0),this.busySettlers=ko.observable(e.busySettlers||0),this.childSettlers=ko.observable($Utils.setDefaultValue(e.childSettlers,1)),this.adultSettlers=ko.observable($Utils.setDefaultValue(e.adultSettlers,1)),this.oldSettlers=ko.observable($Utils.setDefaultValue(e.oldSettlers,1)),this.resources=ko.observable(e.resources||this._getDefaultResources()),this.playSpeed=ko.observable(1),this.mapArray=ko.observable([]),this.newGameGeneratedMaps=ko.observableArray([]),this.selectedMapIdx=ko.observable(),this.leadersToChooseFrom=ko.observableArray([]),this.selectedLeaderIdx=ko.observable(),this.totalSettlers=ko.computed(function(){return(t.availableSettlers()||0)+(t.workingSettlers()||0)+(t.busySettlers()||0)}),document.getElementById("current-hour").innerHTML=this.currentHour,document.getElementById("current-day").innerHTML=this.currentDay,document.getElementById("current-season").innerHTML=this.currentSeason,document.getElementById("current-year").innerHTML=this.yearCounter,this._setupDefaultTimeEvents(),this.leadersToChooseFrom([{id:"torvald",name:"Torvald Magnusson",age:44,bio:"Until very recently, a much-beloved CEO of a Fortune 100 company. According to his husband, Torvald could \"charm the spots off a leopard.\" There's usually less working and a lot more talking when he's around, but everybody sure has a good time.",strengthDescription:"",weaknessDescription:""},{id:"melody",name:"Melody Sterling",age:28,bio:"Raised on a farm, Melody has never been one to shy away from hard work. Somewhat plain-spoken, but you'll not find anyone more practical or earnest. Whenever she has spare time she likes to play the guitar or sew.",strengthDescription:"",weaknessDescription:""},{id:"philip",name:"Philip Olivares",age:35,bio:"A self-professed nerd and history buff. Highly intelligent, you'll usually find Philip with his nose in a book. His \"big picture\" worldview tends to give those around him the impression that he's a bit out of touch with reality.",strengthDescription:"",weaknessDescription:""}])},Game.prototype.mainLoop=function(){this.currentHour,this.currentDay,this.currentSeasonIdx;this.hourCounter++,this.currentHour=this.hourCounter%24,document.getElementById("current-hour").innerHTML=this.currentHour,this.processHourlyEvents(),0==this.currentHour&&(this.dayCounter++,this.currentDay=this.dayCounter%30,document.getElementById("current-day").innerHTML=this.currentDay,this.processDailyEvents(),0==this.currentDay&&(this.seasonCounter++,this.currentSeasonIdx=this.seasonCounter%4,this.currentSeason=this.seasons[this.currentSeasonIdx],document.getElementById("current-season").innerHTML=this.currentSeason,this.processSeasonalEvents(),0==this.currentSeasonIdx&&(this.yearCounter++,document.getElementById("current-year").innerHTML=this.yearCounter,this.processYearlyEvents())))},Game.prototype.processHourlyEvents=function(){var e=this.hourlyEvents[this.currentHour];void 0!=e&&$.each(e,function(e,t){game[t]()})},Game.prototype.processDailyEvents=function(){var e=this.dailyEvents[this.currentDay];void 0!=e&&$.each(e,function(e,t){game[t]()}),this._doDailyStarvationCalculation(),this.dailyMealsDesired=0,this.dailyMealsServed=0},Game.prototype.processSeasonalEvents=function(){var e=this.seasonalEvents[this.seasonCounter];void 0!=e&&$.each(e,function(e,t){game[t]()}),this.doChildAgingEventCheck(),this.doAdultAgingEventCheck(),this.doDeathEventCheck()},Game.prototype.processYearlyEvents=function(){},Game.prototype._doDailyStarvationCalculation=function(){this.dailyMealsServed/this.dailyMealsDesired<.6?(this.starvationMarkers++,this.starvationMarkers>10&&(this.starvationMarkers=10),console.log("Starvation markers: "+this.starvationMarkers)):(this.starvationMarkers-=2,this.starvationMarkers<0&&(this.starvationMarkers=0),console.log("Starvation markers: "+this.starvationMarkers)),this.starvationMarkers>3&&this.processStarvationEvent()},Game.prototype.consumeFoodEvent=function(){var e=this.resources().food,t=this.totalSettlers();this.dailyMealsDesired+=t;var s=e-t,o=0>s?t+s:t;this.dailyMealsServed+=o,this._updateObservableProp(this.resources,{food:e-o}),console.log("Food leftover after serving: "+this.resources().food)},Game.prototype.doChildAgingEventCheck=function(){void 0!=this.scheduledChildAgingEvents[this.seasonCounter]&&this.ageChildren(this.scheduledChildAgingEvents[this.seasonCounter])},Game.prototype.doAdultAgingEventCheck=function(){void 0!=this.scheduledAdultAgingEvents[this.seasonCounter]&&this.ageAdults(this.scheduledAdultAgingEvents[this.seasonCounter])},Game.prototype.doDeathEventCheck=function(){void 0!=this.scheduledDeathEvents[this.seasonCounter]&&this.killOldAdults(this.scheduledDeathEvents[this.seasonCounter])},Game.prototype.ageChildren=function(e){for(var t=0;e>t;t++){var s=4*$Utils.doRand(40,51),o=this.seasonCounter+s;this.scheduledAdultAgingEvents[o]=(this.scheduledAdultAgingEvents[o]||0)+1}},Game.prototype.ageAdults=function(e){for(var t=0;e>t;t++){var s=4*$Utils.doRand(10,21),o=this.seasonCounter+s;this.scheduledDeathEvents[o]=(this.scheduledDeathEvents[o]||0)+1}},Game.prototype.killOldAdults=function(e){for(var t=0;e>t;t++)this.availableSettlers()>0?(this.availableSettlers(this.availableSettlers()-1),console.log("A settler has died of old age. Num left: "+this.totalSettlers())):this.workingSettlers()>0?(this.workingSettlers(this.workingSettlers()-1),console.log("A settler has died of old age. Num left: "+this.totalSettlers())):this.busySettlers()>0&&(this.busySettlers(this.busySettlers()-1),console.log("A settler has died of old age. Num left: "+this.totalSettlers())),0==this.availableSettlers()&&0==this.workingSettlers()&&0==this.busySettlers()&&this.gameOver()},Game.prototype.processStarvationEvent=function(){var e=$Utils.doRand(1,11);e<=this.starvationMarkers&&(this.availableSettlers()>0?(this.availableSettlers(this.availableSettlers()-1),console.log("A settler has died. Num left: "+this.totalSettlers())):this.workingSettlers()>0?(this.workingSettlers(this.workingSettlers()-1),console.log("A settler has died. Num left: "+this.totalSettlers())):this.busySettlers()>0&&(this.busySettlers(this.busySettlers()-1),console.log("A settler has died. Num left: "+this.totalSettlers())),0==this.totalSettlers()&&this.gameOver())},Game.prototype.startMainTimer=function(){var e=this;this.timer=setInterval(function(){e.mainLoop()},this.timerInterval)},Game.prototype.pauseMainTimer=function(){clearInterval(this.timer)},Game.prototype.restartMainTimer=function(){this.pauseMainTimer(),this.startMainTimer()},Game.prototype.spcAction=function(){this.isPopupVisible||(this.isPlaying?this.pauseMainTimer():this.isGameOver||this.startMainTimer(),this.isPlaying=!this.isPlaying)},Game.prototype.plusAction=function(){4!=this.playSpeed()&&(this.playSpeed(this.playSpeed()+1),this._setIntervalBasedOnPlaySpeedInteger(),this.isPlaying&&this.restartMainTimer())},Game.prototype.minusAction=function(){1!=this.playSpeed()&&(this.playSpeed(this.playSpeed()-1),this._setIntervalBasedOnPlaySpeedInteger(),this.isPlaying&&this.restartMainTimer())},Game.prototype._setIntervalBasedOnPlaySpeedInteger=function(){1==this.playSpeed()?this.timerInterval=1e3:2==this.playSpeed()?this.timerInterval=500:3==this.playSpeed()?this.timerInterval=250:4==this.playSpeed()&&(this.timerInterval=100)},Game.prototype._updateObservableProp=function(e,t,s,o){if(!ko.isObservable(e))return console.log("_updateObservableProp requires an observable as its first argument"),!1;s=$Utils.setDefaultValue(s,0),o=$Utils.setDefaultValue(o,1);var i=e(),n=[];for(existingProp in i)void 0!=t[existingProp]?(i[existingProp]=t[existingProp],delete t[existingProp]):n.push(existingProp);if(s&&$.each(n,function(e,t){delete i[t]}),o)for(newProp in t)i[newProp]=t[newProp];e(i)},Game.prototype._hideOneElemAndShowAnother=function(e,t,s,o,i){var n=new Promise(function(n){e=e instanceof jQuery?e:$(e),t=t instanceof jQuery?t:$(t),s=void 0!=s?s:300,o=void 0!=o?o:300,e.fadeOut(s,function(){i&&"function"==typeof i&&i(),t.fadeIn(o,function(){setTimeout(function(){n()},0)})})});return n},Game.prototype.revealText=function(e,t,s){var o=new Promise(function(o){e=e instanceof jQuery?e:$(e),0==e.length&&o(),t=void 0!=t?t:2e3,s=s||0;var i=e.css("position"),n=e.css("overflow");e.css("position","relative"),e.css("overflow","hidden");var r=$("<div></div>").css({position:"absolute",top:"0px",left:"-10%",width:"110%",height:"100%"}).addClass("white-gradient-with-left-transparency").appendTo(e);e.show(),r.animate({left:"100%"},t,"linear",function(){r.remove(),e.css("position",i),e.css("overflow",n),setTimeout(function(){o()},s)})});return o},Game.prototype.fadeOutDiv=function(e,t,s){var o=new Promise(function(o){e=e instanceof jQuery?e:$(e),t=void 0!=t?t:2e3,s=s||0;var i=e.css("position"),n=e.css("overflow");e.css("position","relative"),e.css("overflow","hidden");var r=$("<div></div>").css({position:"absolute",top:"-125%",left:"0px",width:"100%",height:"125%"}).addClass("white-gradient-with-bottom-transparency").appendTo(e);r.animate({top:"0%"},t,"linear",function(){e.hide(0,function(){r.remove(),e.css("position",i),e.css("overflow",n),setTimeout(function(){o()},s)})})});return o},Game.prototype.generateHeightMapUsingParticleDepositionAlgorithm=function(e){e=e||{};for(var t,s,o=e.width||100,i=e.height||100,n=e.numberOfDropPoints||10,r=e.minParticlesPerPoint||1,a=e.maxParticlesPerPoint||5,l=e.numPasses||1,h=e.minRadiusToLookForLowerNeighbors||1,u=e.maxRadiusToLookForLowerNeighbors||1,d=e.dontRepeatPoints||0,c=$Utils.setDefaultValue(e.numBlurPasses,1),p=$Utils.setDefaultValue(e.moveTowardsCenterOnSuccessivePasses,1),v=$Utils.setDefaultValue(e.edgePadding,1),f=f||"terrain",g=[],m={},y=0;i>y;y++){void 0==g[y]&&(g[y]=[]);for(var E=0;o>E;E++)g[y][E]=0}for(var S=0;l>S;S++){var b=1+v,M=i-v,T=1+v,w=o-v;if(p){var P=Math.round(o/2),G=Math.round(i/2),C=Math.round(.25*o),D=G-C,k=G+C,A=P-C,I=P+C;b+=S,M-=S,T+=S,w-=S,b=b>D?D:b,M=k>M?k:M,T=T>A?A:T,w=I>w?I:w}for(var O=0;n>O;O++){for(s=$Utils.doRand(b,M),t=$Utils.doRand(T,w),void 0==m[s]&&(m[s]={});d&&1==m[s][t];)s=$Utils.doRand(b,M),t=$Utils.doRand(T,w),void 0==m[s]&&(m[s]={});d&&(m[s][t]=1);for(var $=($Utils.doRand(r,a+1),0);n>$;$++){g[s][t]+=1;var L=$Utils.doRand(h,u+1),N=this._getLowestPointNeighbor(s,t,L,i,o,g);g[s][t]-N.z>1&&(g[s][t]-=1,g[N.y][N.x]+=1)}}}c>0&&(g=this._applyBlurToMap(c,g));var _=["#0004E3","#D0E300","#56C656","#0a9000","#8C8C8C","#8C8C8C"],x=["water","sand","grassland","woods","mountain","mountain"];return g=this._getMapArrayCoalescedAndTransformedIntoGivenParameters(g,"terrain"==f?x:_,"terrain"==f?"mountain":"#8C8C8C")},Game.prototype._getLowestPointNeighbor=function(e,t,s,o,i,n){for(var r=0>e-s?0:e-s,a=e+s>o?o-1:e+s,l=0>t-s?0:t-s,h=t+s>i?i-1:t+s,u={},d=r;a>d;d++)for(var c=l;h>c;c++){var p=n[d][c];void 0==u[p]&&(u[p]=[]),u[p].push({x:c,y:d,z:p})}var v=Object.keys(u).sort(),f=v[0];return $Utils.chooseRandomly(u[f])},Game.prototype._applyBlurToMap=function(e,t){for(var s,o,i,n,r=[],a=[],l=[.06136,.24477,.38774,.24477,.06136],h=l,u=Math.round(h.length/2)-1,d=0,c=0;e>c;c++){n=0==r.length?t:r;for(var p=0;p<n.length;p++)for(var v=0;v<n[p].length;v++){d=0;for(var f=0;f<h.length;f++)s=f-u,o=v+s,o=0>o?0:o,o=o>n[p].length-1?n[p].length-1:o,d+=n[p][o]*h[f];void 0==a[p]&&(a[p]=[]),a[p][v]=Math.ceil(d)}for(var g=0;g<a.length;g++)for(var m=0;m<a[g].length;m++){for(d=0,f=0;f<h.length;f++)s=f-u,i=g+s,i=0>i?0:i,i=i>a.length-1?a.length-1:i,d+=a[i][m]*h[f];void 0==r[g]&&(r[g]=[]),r[g][m]=Math.ceil(d)}}return r},Game.prototype._coalesceMapHeightsIntoSequentialValues=function(e,t,s){s=s||0;var o=this._getDistinctHeights(e),i=o[0],n=o[o.length-1],r=n-i,a=r+1;t=t>a?a:t;var l=Math.floor((r+1)/t);s&&(l=1);var h=_.map(o,function(e,t){return t%l===0?o.slice(t,t+l):null}).filter(function(e){return e});return h},Game.prototype._getDistinctHeights=function(e){for(var t={},s=0;s<e.length;s++)for(var o=0;o<e[s].length;o++)t[e[s][o]]=1;var i=Object.keys(t).sort();return i},Game.prototype._getMapArrayCoalescedAndTransformedIntoGivenParameters=function(e,t,s){var o,i=0;void 0==t?(o=1,i=1,t=[],s="#ff0000"):o=t.length;var n=this._coalesceMapHeightsIntoSequentialValues(e,o,i),r=n.length,a={};_.forEach(n,function(e,t){_.forEach(e,function(e){a[e]=t})});var l,h,u,d,c=[];if(i){var p=Math.floor(255/r);for(h=0;255>h;h+=p)l=h.toString(16),1==l.length&&(l="0"+l),t.push("#"+l+l+l)}for(var v=(Object.keys(t),0);v<e.length;v++)for(var f=0;f<e[v].length;f++)u=e[v][f],d=void 0!=t[a[u]]?t[a[u]]:s,void 0==c[v]&&(c[v]=[]),c[v][f]={mappedValue:d,height:u};return c},Game.prototype.translateHeightsIntoTerrain=function(){},Game.prototype._getMinAndMaxHeights=function(e){for(var t,s,o,i=0;i<e.length;i++)for(var n=0;n<e[i].length;n++)o=e[i][n],void 0==t&&void 0==s&&(t=o,s=o),t>o&&(t=o),o>s&&(s=o);return[t,s]},Game.prototype._TESTLOGMAP=function(e){for(var t=0;t<e.length;t++)console.log(e[t].join(" "))},Game.prototype.gameOver=function(){console.log("No settlers left."),this.pauseMainTimer(),this.isGameOver=1},Game.prototype.newGame=function(){var e=this,t=[];this._hideOneElemAndShowAnother("#newgame-content","#loading",300,300).then(function(){return new Promise(function(s){for(var o=0;6>o;o++)t.push(game.generateHeightMapUsingParticleDepositionAlgorithm({width:50,height:50,numberOfDropPoints:10,minParticlesPerPoint:1,maxParticlesPerPoint:1,numPasses:10,minRadiusToLookForLowerNeighbors:1,maxRadiusToLookForLowerNeighbors:1,numBlurPasses:2,edgePadding:5}));e.newGameGeneratedMaps(t),s()})}).then(function(){return e._hideOneElemAndShowAnother("#loading","#intro-content",0,300)}).then(function(){return e.revealText("#intro-s1-p1",0,0)}).then(function(){return e.revealText("#intro-s1-p2",0,0)}).then(function(){$("#intro-s1-buttons").fadeIn(0)})},Game.prototype._setupDefaultTimeEvents=function(){var e=this;$.each([7,12,18],function(t,s){e.hourlyEvents[s]=$Utils.pushOntoArray(e.hourlyEvents[s],"consumeFoodEvent")})},Game.prototype._getDefaultResources=function(){return{food:105}},Game.prototype._translateTerrainTypeIntoColor=function(e){var t={water:"#0004E3",sand:"#D0E300",grassland:"#56C656",woods:"#0a9000",mountain:"#8C8C8C"};return void 0!=t[e]?t[e]:"#ffffff"},Game.prototype.continueIntroFrom=function(e){var t=this;"p1"==e?this.fadeOutDiv("#intro-s1",600).then(function(){return $("#intro-s2").show(),t.revealText("#intro-s2-p1",3e3,0)}).then(function(){return t.revealText("#intro-s2-p2",3e3,1e3)}).then(function(){$("#intro-s2-buttons").fadeIn(500)}):"p2"==e&&this.fadeOutDiv("#intro-s2",600).then(function(){return $("#intro-s3").show(),t.revealText("#intro-s3-p1",3e3,0)}).then(function(){return t.revealText("#intro-s3-p2",3e3,1e3)}).then(function(){return t.revealText("#intro-s3-p3",1e3,2e3)}).then(function(){$("#intro-s3-buttons").fadeIn(500)})},Game.prototype.hideModal=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.showModalClose=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.modalWindowTitle=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.modalWindowText=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.showModalWindowFooter=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.loadGame=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.saveGame=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.logMessages=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.showFaq=function(){console.log("NOT IMPLEMENTED YET")};