var $Utils=Utils.prototype,Game=function(e){this.init(e)};Game.prototype.init=function(e){var t=this,o=!1;(void 0==e||e=={})&&(o=!0,e={}),this.seasons=["Spring","Summer","Fall","Winter"],this.timer,this.hourCounter=e.hourCounter||1,this.dayCounter=e.dayCounter||1,this.seasonCounter=e.seasonCounter||0,this.yearCounter=e.yearCounter||1,this.currentHour=e.currentHour||1,this.currentDay=e.currentDay||1,this.currentSeason=this.seasons[this.seasonCounter%4],this.isPlaying=e.isPlaying||0,this.timerInterval=e.timerInterval||1e3,this.isPopupVisible=e.isPopupVisible||0,this.hourlyEvents=e.hourlyEvents||{},this.dailyEvents=e.dailyEvents||{},this.seasonalEvents=e.seasonalEvents||{},this.yearlyEvents=e.yearlyEvents||{},this.dailyMealsDesired=e.dailyMealsDesired||0,this.dailyMealsServed=e.dailyMealsServed||0,this.lowFoodDaysCount=e.lowFoodDaysCount||0,this.isGameOver=e.isGameOver||0,this.scheduledChildAgingEvents=e.scheduledChildAgingEvents||{7:1},this.scheduledAdultAgingEvents=e.scheduledAdultAgingEvents||{9:1,12:1,16:1},this.scheduledDeathEvents=e.scheduledAgingEvents||{22:1},this.isDebugMode=0,this.introCompleted=e.introCompleted||0,this.wordForSettlersSingle=e.wordForSettlersSingle||0,this.wordForSettlersPlural=e.wordForSettlersPlural||0,this.buildingSquares=e.buildingSquares||[],this.availableSettlers=ko.observable($Utils.setDefaultValue(e.availableSettlers,5)),this.busySettlers=ko.observable(e.busySettlers||0),this.settlerJobs=ko.observable(e.settlerJobs||{scavenger:0,builder:0}),this.settlerJobCapacities=ko.observable(e.settlerJobCapacities||{}),this.childSettlers=ko.observable($Utils.setDefaultValue(e.childSettlers,1)),this.adultSettlers=ko.observable($Utils.setDefaultValue(e.adultSettlers,1)),this.oldSettlers=ko.observable($Utils.setDefaultValue(e.oldSettlers,1)),this.resources=ko.observable(e.resources||this._getDefaultResources()),this.playSpeed=ko.observable(e.playspeed||1),this.newGameGeneratedMaps=ko.observableArray([]),this.selectedMapIdx=ko.observable(),this.leadersToChooseFrom=ko.observableArray([]),this.selectedLeaderIdx=ko.observable($Utils.setDefaultValue(e.selectedLeaderIdx,-1)),this.currentlySelectedCell=ko.observable(""),this.starvationMarkers=ko.observable(e.starvationMarkers||0),this.oldAgeDeaths=ko.observable(e.oldAgeDeaths||0),this.starvationDeaths=ko.observable(e.starvationDeaths||0),this.gameMapRows=ko.observableArray([]).extend({notify:"always"}),this.gameMap=ko.observable(0).extend({notify:"always"}),e.gameMap&&(this.gameMap(new GameMap(e.gameMap)),t.gameMapRows(t.gameMap().rows())),this.workingSettlers=ko.computed(function(){var e=0,o=t.settlerJobs();return _.forEach(Object.keys(o),function(t){e+=o[t]}),e}),this.totalSettlers=ko.computed(function(){return(t.availableSettlers()||0)+(t.workingSettlers()||0)+(t.busySettlers()||0)}),this.settlerJobTypesArray=ko.computed(function(){var e=t.settlerJobs(),o=(Object.keys(e),[]);return _.forEach(Object.keys(e),function(s){var r={job:s,numSettlers:e[s]};void 0!=t.settlerJobCapacities()[s]&&(r.maxSettlers=t.settlerJobCapacities()[s]),o.push(r)}),o}),this.gameMap.subscribe(function(e){console.log("shit changed");var o=[],s=$("#game-map"),r=e.rows();_.forEach(r,function(e){o.push('<div class="map-row">'),_.forEach(e,function(e){var s=e.construction_required>0,r=t.currentlySelectedCell(),i=e.row==r.row&&e.column==r.column;o.push('<div class="map-cell xlg '+(s?"construction ":"")+(i?"selected ":"")+'" style="background-color : '+t._translateTerrainTypeIntoColor(e)+'" data-bind="click : function() { setActiveCell('+e.row+","+e.column+') }"></div>')}),o.push('<div class="clear"></div>'),o.push("</div>")}),s.html(o.join("")),ko.applyBindingsToDescendants(t,s[0])}),document.getElementById("current-hour").innerHTML=this.currentHour,document.getElementById("current-day").innerHTML=this.currentDay,document.getElementById("current-season").innerHTML=this.currentSeason,document.getElementById("current-year").innerHTML=this.yearCounter,o&&this._setupDefaultTimeEvents(),this.leadersToChooseFrom([{id:"torvald",name:"Torvald Magnusson",age:44,bio:"Until very recently, a much-beloved CEO of a Fortune 100 company. According to his husband, Torvald's silver tongue could \"charm the spots off a leopard.\" There's usually less working and a lot more talking when he's around, but everybody sure has a good time.",strengthDescription:"+2 Recruitment",weaknessDescription:"-1 Construction",textStages:{s2:'Well, this is something that Tony Robbins never talked about, that\'s for sure. I can make this work, though. Just have to adapt. Think of it as...drastically changing market conditions. Going to see how many people I can recruit for this new "enterprise."',s3:'Alright, seems we\'ve got a few new "hires." One of them has some knowledge of local resources to boot. Now that\'s someone you want around! Her first task as head of the newly formed Location Selection Department was to draw me up a map of the area from her memory. I\'ve decided to "incorporate" us here:',s4:"It's taken several days of travel, but we've made it, I think! It's been a couple days since we encountered anyone else, at least, so I'm sure we're not in any immediate danger. We've got some basic shelter established, courtesy of one of the same woman who drew up the maps. Need to think about promoting her. Company morale is a little shaky right now, so it would probably be safer to wait. Enough idle thought for now. If this enterprise is going to succeed, I'll need to start divying up tasks sooner than later. Time to show these people why I make the big bucks. Oh...\"made\", I guess."},wordForSettlersSingle:"Employee",wordForSettlersPlural:"Employees"},{id:"melody",name:"Melody Sterling",age:28,bio:"Raised on a farm, Melody has never been one to shy away from hard work. Somewhat plain-spoken, but you'll not find anyone more practical or earnest. Whenever she has spare time she likes to play the guitar or sew.",strengthDescription:"+1 Construction",weaknessDescription:"",textStages:{s2:"Well, this is certainly a turn of events. Seems what's done is done, though. No sense in crying over spilt milk. Nobody's stepped up to take the reins yet, but someone's got to or ain't a one of us gonna make it. Will see how many of us I can get together. Need to move fast or there might not be anything left worth saving.",s3:"Found some people willing to make a go of it. Not so different than our ancestors, I suppose. It looks like I've got the most knowledge of the area, so it's fallen to me to pick the best place to settle. Not sure I'm an expert, but I've got a few locations in mind. I think we should try here: ",s4:"Well, we made it. Looks just about like I remember, fortunately. The journey was...it's not something I want to talk about just yet. Just...just need to focus on surviving for now. Now more than ever these folks need hope, and I'll be damned if I'm not going to try. We have to try, we've just got to. Enough chit-chat, though, there's a lot of work to do."},wordForSettlersSingle:"Survivor",wordForSettlersPlural:"Survivors"},{id:"philip",name:"Philip Olivares",age:35,bio:"A self-professed nerd and history buff. Highly intelligent, you'll usually find Philip with his nose in a book. His \"big picture\" worldview tends to give those around him the impression that he's a bit out of touch with reality.",strengthDescription:"+2 Research",weaknessDescription:"-1 Recruitment",textStages:{s2:"Implementing phase one of Neo-Feudal System. Must think of better name than that. Need to keep the laborers happy. Will report back on recruitment efforts.",s3:"Selection of ideal settling location is necessary. Essential in these first few days to establish position at top of new order. Located several maps of the area. Will tell the others we are settling here:",s4:"Journey completed. Site looks promising. Believe I have sucessfully established myself at top of new hierarchy while en route. This is good, it is essential to maintain control during early stages. Rudimentary home base has been established. Time to start assigning jobs to individuals to ensure survival of tribe."},wordForSettlersSingle:"Subject",wordForSettlersPlural:"Subjects"}])},Game.prototype.mainLoop=function(){this.currentHour,this.currentDay,this.currentSeasonIdx;this.hourCounter++,this.currentHour=this.hourCounter%24,document.getElementById("current-hour").innerHTML=this.currentHour,this.processHourlyEvents(),0==this.currentHour&&(this.dayCounter++,this.currentDay=this.dayCounter%30,document.getElementById("current-day").innerHTML=this.currentDay,this.processDailyEvents(),0==this.currentDay&&(this.seasonCounter++,this.currentSeasonIdx=this.seasonCounter%4,this.currentSeason=this.seasons[this.currentSeasonIdx],document.getElementById("current-season").innerHTML=this.currentSeason,this.processSeasonalEvents(),0==this.currentSeasonIdx&&(this.yearCounter++,document.getElementById("current-year").innerHTML=this.yearCounter,this.processYearlyEvents())))},Game.prototype.processHourlyEvents=function(){var e=this.hourlyEvents[this.currentHour];void 0!=e&&$.each(e,function(e,t){game[t]()})},Game.prototype.processDailyEvents=function(){var e=this.dailyEvents[this.currentDay];void 0!=e&&$.each(e,function(e,t){game[t]()}),this._doDailyStarvationCalculation(),this.dailyMealsDesired=0,this.dailyMealsServed=0},Game.prototype.processSeasonalEvents=function(){var e=this.seasonalEvents[this.seasonCounter];void 0!=e&&$.each(e,function(e,t){game[t]()}),this.doChildAgingEventCheck(),this.doAdultAgingEventCheck(),this.doDeathEventCheck()},Game.prototype.processYearlyEvents=function(){},Game.prototype._doDailyStarvationCalculation=function(){var e=this.starvationMarkers();this.dailyMealsServed/this.dailyMealsDesired<.6?(e++,e>10&&(e=10),console.log("Starvation markers: "+e)):(e-=2,0>e&&(e=0),console.log("Starvation markers: "+e)),this.starvationMarkers(e),this.starvationMarkers()>3&&this.processStarvationEvent()},Game.prototype.consumeFoodEvent=function(){var e=this.resources().food,t=this.totalSettlers();this.dailyMealsDesired+=t;var o=e-t,s=0>o?t+o:t;this.dailyMealsServed+=s,this._updateObservableProp(this.resources,{food:e-s}),console.log("Food leftover after serving: "+this.resources().food)},Game.prototype.buildFarm=function(){var e=this;if(this.hasSufficientBuildingMaterialsForBuildingType("farm")){var t=this.getRequiredBuildingMaterials("farm");_.forEach(t,function(t,o){e.resources()[o]=e.resources()[o]-t}),e.resources(e.resources());var o=this.currentlySelectedCell(),s={improvement_type:"farm",construction_progress:0,construction_required:40};this.gameMap(this.gameMap().updateCell(o.row,o.column,s)),this.buildingSquares.push($.extend(o,s)),this._updateActiveCell()}},Game.prototype.doChildAgingEventCheck=function(){void 0!=this.scheduledChildAgingEvents[this.seasonCounter]&&this.ageChildren(this.scheduledChildAgingEvents[this.seasonCounter])},Game.prototype.doAdultAgingEventCheck=function(){void 0!=this.scheduledAdultAgingEvents[this.seasonCounter]&&this.ageAdults(this.scheduledAdultAgingEvents[this.seasonCounter])},Game.prototype.doDeathEventCheck=function(){void 0!=this.scheduledDeathEvents[this.seasonCounter]&&this.killOldAdults(this.scheduledDeathEvents[this.seasonCounter])},Game.prototype.ageChildren=function(e){for(var t=0;e>t;t++){var o=4*$Utils.doRand(40,51),s=this.seasonCounter+o;this.scheduledAdultAgingEvents[s]=(this.scheduledAdultAgingEvents[s]||0)+1}},Game.prototype.ageAdults=function(e){for(var t=0;e>t;t++){var o=4*$Utils.doRand(10,21),s=this.seasonCounter+o;this.scheduledDeathEvents[s]=(this.scheduledDeathEvents[s]||0)+1}},Game.prototype.killOldAdults=function(e){for(var t=0;e>t;t++){if(this.availableSettlers()>0)this.availableSettlers(this.availableSettlers()-1),this.oldAgeDeaths(this.oldAgeDeaths()+1),console.log("A settler has died of old age. Num left: "+this.totalSettlers());else if(this.workingSettlers()>0){var o=[],s=this.settlerJobs();_.forEach(Object.keys(s),function(e){s[e]>0&&o.push(e)});var r=$Utils.chooseRandomly(o),i={};i[r]=s[r]-1,this._updateObservableProp(this.settlerJobs,i),this.oldAgeDeaths(this.oldAgeDeaths()+1),console.log("A settler has died of old age. Num left: "+this.totalSettlers())}else this.busySettlers()>0&&(this.busySettlers(this.busySettlers()-1),this.oldAgeDeaths(this.oldAgeDeaths()+1),console.log("A settler has died of old age. Num left: "+this.totalSettlers()));0==this.availableSettlers()&&0==this.workingSettlers()&&0==this.busySettlers()&&this.gameOver()}},Game.prototype.processStarvationEvent=function(){var e=$Utils.doRand(1,11);if(e<=this.starvationMarkers()){if(this.availableSettlers()>0)this.availableSettlers(this.availableSettlers()-1),this.starvationDeaths(this.starvationDeaths()+1),console.log("A settler has died. Num left: "+this.totalSettlers());else if(this.workingSettlers()>0){var t=[],o=this.settlerJobs();_.forEach(Object.keys(o),function(e){o[e]>0&&t.push(e)});var s=$Utils.chooseRandomly(t),r={};r[s]=o[s]-1,this._updateObservableProp(this.settlerJobs,r),this.starvationDeaths(this.starvationDeaths()+1),console.log("A settler has died. Num left: "+this.totalSettlers())}else this.busySettlers()>0&&(this.busySettlers(this.busySettlers()-1),this.starvationDeaths(this.starvationDeaths()+1),console.log("A settler has died. Num left: "+this.totalSettlers()));0==this.totalSettlers()&&this.gameOver()}},Game.prototype.processScavengingEvent=function(){for(var e,t=this.settlerJobs().scavenger,o=0;t>o;o++)if(e=$Utils.doBasedOnPercent({10:["food","timber","stone","scrap","tools"],50:0})){var s={};s[e]=this.resources()[e]+1,this._updateObservableProp(this.resources,s)}},Game.prototype.processConstructionEvent=function(){var e=this.settlerJobs().builder;if(this.buildingSquares.length>0&&e>0){var t=this.buildingSquares[0];t.construction_progress+=e,t.construction_progress>=t.construction_required?(this._completeConstruction(t),this.buildingSquares.shift()):this._updateConstructionProgress(t);var o=this.currentlySelectedCell();t.row==o.row&&t.column==o.column&&this._updateActiveCell()}},Game.prototype.processFarmingEvent=function(){var e=this.settlerJobs().farmer;if(this.settlerJobCapacities().farmer>0&&e>0){var t=e,o=this.resources().food;this._updateObservableProp(this.resources,{food:o+t})}},Game.prototype._updateConstructionProgress=function(e){var t={construction_progress:e.construction_progress};this.gameMap().updateCell(e.row,e.column,t)},Game.prototype._completeConstruction=function(e){var t={construction_progress:void 0,construction_required:0,improvement_hp:100,improvement_level:1};this.gameMap(this.gameMap().updateCell(e.row,e.column,t));var o;"farm"==e.improvement_type&&(void 0==this.settlerJobs().farmer&&(this._updateObservableProp(this.settlerJobs,{farmer:0}),this._updateObservableProp(this.settlerJobCapacities,{farmer:0})),o=this.settlerJobCapacities().farmer,this._updateObservableProp(this.settlerJobCapacities,{farmer:o+2}))},Game.prototype._updateActiveCell=function(){var e=this.currentlySelectedCell();e&&this.currentlySelectedCell(this.gameMap().getCell(e.row,e.column))},Game.prototype.startMainTimer=function(){var e=this;this.timer=setInterval(function(){e.mainLoop()},this.timerInterval)},Game.prototype.pauseMainTimer=function(){clearInterval(this.timer)},Game.prototype.restartMainTimer=function(){this.pauseMainTimer(),this.startMainTimer()},Game.prototype.spcAction=function(){this.isPopupVisible||(this.isPlaying?this.pauseMainTimer():this.isGameOver||this.startMainTimer(),this.isPlaying=!this.isPlaying)},Game.prototype.plusAction=function(){4!=this.playSpeed()&&(this.playSpeed(this.playSpeed()+1),this._setIntervalBasedOnPlaySpeedInteger(),this.isPlaying&&this.restartMainTimer())},Game.prototype.minusAction=function(){1!=this.playSpeed()&&(this.playSpeed(this.playSpeed()-1),this._setIntervalBasedOnPlaySpeedInteger(),this.isPlaying&&this.restartMainTimer())},Game.prototype._setIntervalBasedOnPlaySpeedInteger=function(){1==this.playSpeed()?this.timerInterval=1e3:2==this.playSpeed()?this.timerInterval=500:3==this.playSpeed()?this.timerInterval=250:4==this.playSpeed()&&(this.timerInterval=100)},Game.prototype._updateObservableProp=function(e,t,o,s){if(!ko.isObservable(e))return console.log("_updateObservableProp requires an observable as its first argument"),!1;o=$Utils.setDefaultValue(o,0),s=$Utils.setDefaultValue(s,1);var r=e(),i=[];for(existingProp in r)void 0!=t[existingProp]?(r[existingProp]=t[existingProp],delete t[existingProp]):i.push(existingProp);if(o&&$.each(i,function(e,t){delete r[t]}),s)for(newProp in t)r[newProp]=t[newProp];e(r)},Game.prototype._hideOneElemAndShowAnother=function(e,t,o,s,r){var i=new Promise(function(i){e=e instanceof jQuery?e:$(e),t=t instanceof jQuery?t:$(t),o=void 0!=o?o:300,s=void 0!=s?s:300,e.fadeOut(o,function(){r&&"function"==typeof r&&r(),t.fadeIn(s,function(){setTimeout(function(){i()},0)})})});return i},Game.prototype.revealText=function(e,t,o){var s=new Promise(function(s){e=e instanceof jQuery?e:$(e),0==e.length&&s(),t=void 0!=t?t:2e3,o=o||0;var r=e.css("position"),i=e.css("overflow");e.css("position","relative"),e.css("overflow","hidden");var n=$("<div></div>").css({position:"absolute",top:"0px",left:"-10%",width:"110%",height:"100%"}).addClass("white-gradient-with-left-transparency").appendTo(e);e.show(),n.animate({left:"100%"},t,"linear",function(){n.remove(),e.css("position",r),e.css("overflow",i),setTimeout(function(){s()},o)})});return s},Game.prototype.fadeOutDiv=function(e,t,o){var s=new Promise(function(s){e=e instanceof jQuery?e:$(e),t=void 0!=t?t:2e3,o=o||0;var r=e.css("position"),i=e.css("overflow");e.css("position","relative"),e.css("overflow","hidden");var n=$("<div></div>").css({position:"absolute",top:"-125%",left:"0px",width:"100%",height:"125%"}).addClass("white-gradient-with-bottom-transparency").appendTo(e);n.animate({top:"0%"},t,"linear",function(){e.hide(0,function(){n.remove(),e.css("position",r),e.css("overflow",i),setTimeout(function(){s()},o)})})});return s},Game.prototype.generateHeightMapUsingParticleDepositionAlgorithm=function(e){e=e||{};for(var t,o,s=e.width||100,r=e.height||100,i=e.numberOfDropPoints||10,n=e.minParticlesPerPoint||1,a=e.maxParticlesPerPoint||5,l=e.numPasses||1,h=e.minRadiusToLookForLowerNeighbors||1,u=e.maxRadiusToLookForLowerNeighbors||1,d=e.dontRepeatPoints||0,c=$Utils.setDefaultValue(e.numBlurPasses,1),p=$Utils.setDefaultValue(e.moveTowardsCenterOnSuccessivePasses,1),v=$Utils.setDefaultValue(e.edgePadding,1),m=m||"terrain",f=[],g={},y=0;r>y;y++){void 0==f[y]&&(f[y]=[]);for(var b=0;s>b;b++)f[y][b]=0}for(var w=0;l>w;w++){var S=1+v,E=r-v,M=1+v,C=s-v;if(p){var T=Math.round(s/2),k=Math.round(r/2),D=Math.round(.25*s),P=k-D,G=k+D,A=T-D,I=T+D;S+=w,E-=w,M+=w,C-=w,S=S>P?P:S,E=G>E?G:E,M=M>A?A:M,C=I>C?I:C}for(var O=0;i>O;O++){for(o=$Utils.doRand(S,E),t=$Utils.doRand(M,C),void 0==g[o]&&(g[o]={});d&&1==g[o][t];)o=$Utils.doRand(S,E),t=$Utils.doRand(M,C),void 0==g[o]&&(g[o]={});d&&(g[o][t]=1);for(var x=($Utils.doRand(n,a+1),0);i>x;x++){f[o][t]+=1;var F=$Utils.doRand(h,u+1),$=this._getLowestPointNeighbor(o,t,F,r,s,f);f[o][t]-$.z>1&&(f[o][t]-=1,f[$.y][$.x]+=1)}}}c>0&&(f=this._applyBlurToMap(c,f));var N=["#0004E3","#D0E300","#56C656","#0a9000","#8C8C8C","#8C8C8C"],L=["water","sand","grassland","woods","mountain","mountain"];f=this._getMapArrayCoalescedAndTransformedIntoGivenParameters(f,"terrain"==m?L:N,"terrain"==m?"mountain":"#8C8C8C");var R=_.map(f,function(e){return _.map(e,function(e){return e.improvement_type=void 0,e.max_resources=500,e.current_resources=500,e.terrain_type=e.mappedValue,delete e.mappedValue,e})});return R},Game.prototype._getLowestPointNeighbor=function(e,t,o,s,r,i){for(var n=0>e-o?0:e-o,a=e+o>s?s-1:e+o,l=0>t-o?0:t-o,h=t+o>r?r-1:t+o,u={},d=n;a>d;d++)for(var c=l;h>c;c++){var p=i[d][c];void 0==u[p]&&(u[p]=[]),u[p].push({x:c,y:d,z:p})}var v=Object.keys(u).sort(),m=v[0];return $Utils.chooseRandomly(u[m])},Game.prototype._applyBlurToMap=function(e,t){for(var o,s,r,i,n=[],a=[],l=[.06136,.24477,.38774,.24477,.06136],h=l,u=Math.round(h.length/2)-1,d=0,c=0;e>c;c++){i=0==n.length?t:n;for(var p=0;p<i.length;p++)for(var v=0;v<i[p].length;v++){d=0;for(var m=0;m<h.length;m++)o=m-u,s=v+o,s=0>s?0:s,s=s>i[p].length-1?i[p].length-1:s,d+=i[p][s]*h[m];void 0==a[p]&&(a[p]=[]),a[p][v]=Math.ceil(d)}for(var f=0;f<a.length;f++)for(var g=0;g<a[f].length;g++){for(d=0,m=0;m<h.length;m++)o=m-u,r=f+o,r=0>r?0:r,r=r>a.length-1?a.length-1:r,d+=a[r][g]*h[m];void 0==n[f]&&(n[f]=[]),n[f][g]=Math.ceil(d)}}return n},Game.prototype._coalesceMapHeightsIntoSequentialValues=function(e,t,o){o=o||0;var s=this._getDistinctHeights(e),r=s[0],i=s[s.length-1],n=i-r,a=n+1;t=t>a?a:t;var l=Math.floor((n+1)/t);o&&(l=1);var h=_.map(s,function(e,t){return t%l===0?s.slice(t,t+l):null}).filter(function(e){return e});return h},Game.prototype._getDistinctHeights=function(e){for(var t={},o=0;o<e.length;o++)for(var s=0;s<e[o].length;s++)t[e[o][s]]=1;var r=Object.keys(t).sort();return r},Game.prototype._getMapArrayCoalescedAndTransformedIntoGivenParameters=function(e,t,o){var s,r=0;void 0==t?(s=1,r=1,t=[],o="#ff0000"):s=t.length;var i=this._coalesceMapHeightsIntoSequentialValues(e,s,r),n=i.length,a={};_.forEach(i,function(e,t){_.forEach(e,function(e){a[e]=t})});var l,h,u,d,c=[];if(r){var p=Math.floor(255/n);for(h=0;255>h;h+=p)l=h.toString(16),1==l.length&&(l="0"+l),t.push("#"+l+l+l)}for(var v=(Object.keys(t),0);v<e.length;v++)for(var m=0;m<e[v].length;m++)u=e[v][m],d=void 0!=t[a[u]]?t[a[u]]:o,void 0==c[v]&&(c[v]=[]),c[v][m]={mappedValue:d,height:u,row:v,column:m};return c},Game.prototype._getMinAndMaxHeights=function(e){for(var t,o,s,r=0;r<e.length;r++)for(var i=0;i<e[r].length;i++)s=e[r][i],void 0==t&&void 0==o&&(t=s,o=s),t>s&&(t=s),s>o&&(o=s);return[t,o]},Game.prototype._TESTLOGMAP=function(e){for(var t=0;t<e.length;t++)console.log(e[t].join(" "))},Game.prototype.setActiveCell=function(e,t){var o=this.gameMap().getCell(e,t),s=this.hasSufficientBuildingMaterialsForBuildingType(this.getBuildingTypeForCellTerrainType(o.terrain_type)),r=$.extend(o,{has_sufficient_building_materials:s});this.currentlySelectedCell(r)},Game.prototype.getDisplayedTerrainTypeForActiveCell=function(){return this.currentlySelectedCell().terrain_type},Game.prototype.getDisplayedTimeFromBaseForActiveCell=function(){return this.gameMap().distanceFromBase(this.currentlySelectedCell())+" Hours"},Game.prototype.getResourceTypeForCellTerrainType=function(e){e=e||this.currentlySelectedCell();var t={water:"fish",sand:"sand",woods:"lumber",mountain:"stone"};return t[e.terrain_type]},Game.prototype.getBuildingTypeForCellTerrainType=function(e){var t={grassland:"farm"};return t[e]},Game.prototype.hasSufficientBuildingMaterialsForBuildingType=function(e){if(void 0==e)return!1;var t=this,o=this.getRequiredBuildingMaterials(),s=!0;return _.forEach(Object.keys(o[e]),function(r){return t.resources()[r]>=o[e][r]?!0:(s=!1,!1)}),s},Game.prototype.getRequiredBuildingMaterials=function(e){var t={farm:{timber:10,stone:10,scrap:2,tools:1}};return void 0!=e&&void 0!=t[e]?t[e]:t},Game.prototype.getDisplayedNameForSettlerJobType=function(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},Game.prototype.addSettlersToJob=function(e){if(0==this.availableSettlers()||void 0!=e.maxSettlers&&e.numSettlers==e.maxSettlers)return!1;var t=this.settlerJobs(),o=e.job,s={};s[o]=t[o]+1,this._updateObservableProp(this.settlerJobs,s),this.availableSettlers(this.availableSettlers()-1)},Game.prototype.removeSettlersFromJob=function(e){if(0==e.numSettlers)return!1;var t=this.settlerJobs(),o=e.job,s={};s[o]=t[o]-1,this._updateObservableProp(this.settlerJobs,s),this.availableSettlers(this.availableSettlers()+1)},Game.prototype.gameOver=function(){console.log("No settlers left."),this.pauseMainTimer(),this.isGameOver=1},Game.prototype.newGame=function(){var e=this,t=[];this._hideOneElemAndShowAnother("#newgame-content","#loading",300,300).then(function(){return new Promise(function(o){for(var s=0;6>s;s++)t.push(game.generateHeightMapUsingParticleDepositionAlgorithm({width:50,height:50,numberOfDropPoints:10,minParticlesPerPoint:1,maxParticlesPerPoint:1,numPasses:10,minRadiusToLookForLowerNeighbors:1,maxRadiusToLookForLowerNeighbors:1,numBlurPasses:2,edgePadding:5}));e.newGameGeneratedMaps(t),o()})}).then(function(){return e._hideOneElemAndShowAnother("#loading","#intro-content",0,300)}).then(function(){return e.revealText("#intro-s1-p1",0,0)}).then(function(){return e.revealText("#intro-s1-p2",0,0)}).then(function(){$("#intro-s1-buttons").fadeIn(0)})},Game.prototype._setupDefaultTimeEvents=function(){var e=this;_.forEach([7,12,18],function(t){e.hourlyEvents[t]=$Utils.pushOntoArray(e.hourlyEvents[t],"consumeFoodEvent")}),_.forEach([12,18],function(t){e.hourlyEvents[t]=$Utils.pushOntoArray(e.hourlyEvents[t],"processScavengingEvent")});for(var t=8;18>t;t++)e.hourlyEvents[t]=$Utils.pushOntoArray(e.hourlyEvents[t],"processConstructionEvent");for(var t=8;18>t;t+=2)e.hourlyEvents[t]=$Utils.pushOntoArray(e.hourlyEvents[t],"processFarmingEvent")},Game.prototype._getDefaultResources=function(){return{food:105,timber:50,stone:50,scrap:20,tools:10}},Game.prototype._translateTerrainTypeIntoColor=function(e){var t={water:"#0004E3",sand:"#D0E300",grassland:"#56C656",woods:"#0a9000",mountain:"#8C8C8C"},o={hq:"#F29057",farm:"#6d4127"};return void 0!=e.improvement_type?void 0!=o[e.improvement_type]?o[e.improvement_type]:"#ffffff":void 0!=t[e.terrain_type]?t[e.terrain_type]:"#ffffff"},Game.prototype.continueIntroFrom=function(e){var t=this,o=game.isDebugMode?0:3e3,s=game.isDebugMode?0:2e3,r=game.isDebugMode?0:1e3;if("s1"==e)this.fadeOutDiv("#intro-s1",game.isDebugMode?0:600).then(function(){return $("#intro-s2").show(),t.revealText("#intro-s2-p1",o,0)}).then(function(){return t.revealText("#intro-s2-p2",o,r)}).then(function(){$("#intro-s2-buttons").fadeIn(500)});else if("s2"==e){var i=this.leadersToChooseFrom(),n=this.selectedLeaderIdx();this.wordForSettlersSingle=i[n].wordForSettlersSingle,this.wordForSettlersPlural=i[n].wordForSettlersPlural,this.fadeOutDiv("#intro-s2",game.isDebugMode?0:600).then(function(){return $("#intro-s3").show(),t.revealText("#intro-s3-p1",o,0)}).then(function(){return t.revealText("#intro-s3-p2",o,r)}).then(function(){return t.revealText("#intro-s3-p3",r,s)}).then(function(){$("#intro-s3-buttons").fadeIn(game.isDebugMode?0:500)})}else"s3"==e?this.fadeOutDiv("#intro-s3",game.isDebugMode?0:600).then(function(){var e=new GameMap({cellArray:t.newGameGeneratedMaps()[t.selectedMapIdx()]});return e.chooseRandomStart(),t.gameMap(e),t.gameMapRows(t.gameMap().rows()),e=void 0,$("#game-time-stats").show(),$("#intro-s4").show(),t.revealText("#intro-s4-p1",o,0)}).then(function(){return t.revealText("#intro-s4-p2",o,r)}).then(function(){$("#intro-s4-buttons").fadeIn(game.isDebugMode?0:500)}):"s4"==e&&this.fadeOutDiv("#intro-s4",game.isDebugMode?0:600).then(function(){return $("#onecol-row").hide(),$("#twocol-row").show(),t.revealText("#twocol-left",o,0)}).then(function(){return t.revealText("#twocol-right",o,r)}).then(function(){t.introCompleted=1,t.spcAction()})},Game.prototype.getLeaderTextFor=function(e){var t=this.leadersToChooseFrom(),o=this.selectedLeaderIdx();return o>-1?t[o].textStages[e]:""},Game.prototype.hideModal=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.showModalClose=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.modalWindowTitle=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.modalWindowText=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.showModalWindowFooter=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.loadGame=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.saveGame=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.logMessages=function(){console.log("NOT IMPLEMENTED YET")},Game.prototype.showFaq=function(){console.log("NOT IMPLEMENTED YET")};